---
title: "ã€React 18ã€‘Concurrent featuresæ¦‚è¦"
emoji: "ğŸŒŸ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["react", "nextjs", "typescript"]
published: true
---

## Concurrent featuresã¨ã¯

Concurrent featuresã¨ã¯ã€Œç”»é¢ä¸Šã«UIã‚’è¡¨ç¤ºã•ã›ã¤ã¤ã€è£ã§ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã®æº–å‚™ã‚’ã™ã‚‹ã€ã¨ã„ã£ãŸä¸¦è¡Œå‡¦ç†ã‚’å®Ÿç¾ã§ãã‚‹ã‚ˆã†ã«ã—ãŸReactã®æ–°ã—ã„ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã§ã™ã€‚
Reactã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯Concurrent featuresã‚’æ­è¼‰ã—ãŸReactã®ã“ã¨ã‚’Concurrent Reactã¨å‘¼ã‚“ã§ã„ã¾ã™ã€‚[^1]

[^1]: [What is Concurrent React? ](https://react.dev/blog/2022/03/29/react-v18#what-is-concurrent-react)

Concurrent featuresã®æœ€å¤§ã®ç‰¹æ€§ã¯ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’ä¸­æ–­ã§ãã‚‹ã¨ã„ã†ã“ã¨ã§ã™ã€‚

å¾“æ¥ã®Reactã§ã¯ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãŒè¡Œã‚ã‚ŒãŸå ´åˆã¯ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãŒå®Œäº†ã™ã‚‹ã¾ã§æ–°ã—ã„ç”»é¢ã‚„æ¬¡ã®æ“ä½œã‚’è¡Œãˆãšã€å¾…ã¡æ™‚é–“ãŒç™ºç”Ÿã—ã¦ã„ã¾ã—ãŸã€‚
ä¸€æ–¹ã€Concurrent featuresã§ã¯ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’ä¸­æ–­ã§ãã‚‹ãŸã‚ã€å¾“æ¥ç™ºç”Ÿã—ã¦ã„ãŸå¾…ã¡æ™‚é–“ã‚’å‰Šæ¸›ã§ãã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ã‚¯ã‚¹ãƒšãƒªã‚¨ãƒ³ã‚¹ã®å‘ä¸ŠãŒæœŸå¾…ã§ãã¾ã™ã€‚

Concurrent featuresã¯å¾“æ¥ã®Reactã®ã‚³ãƒ³ã‚»ãƒ—ãƒˆã‚’å¤‰ãˆã‚‹ã—ãã¿ã¨ãªã£ã¦ã„ã‚‹ãŸã‚ã€Concurrent featuresãŒReact 18ã«ãŠã‘ã‚‹æœ€å¤§ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã„ã£ã¦ã‚‚éè¨€ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

## React 18ã¨Concurrent featuresã«ã¤ã„ã¦

React 18ã§å°å…¥ã•ã‚ŒãŸæ©Ÿèƒ½ã®ä¸€è¦§ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚[^new-features]

- Automatic Batching
- Suspenseã®SSRå¯¾å¿œ
- Transitions
- React DOM Clientã®APIè¿½åŠ 
  - createRoot
  - hydrateRoot
- React DOM Serverã®APIã®è¿½åŠ 
  - renderToPipeableStream
  - renderToReadableStream
- Strictãƒ¢ãƒ¼ãƒ‰ã®æŒ™å‹•ã®å¤‰æ›´
- æ–°ã—ã„Hooksã®è¿½åŠ 
  - useId
  - useTransition
  - useDeferredValue
  - useSyncExternalStore
  - useInsertionEffect

[^new-features]: [Whatâ€™s New in React 18](https://react.dev/blog/2022/03/29/react-v18#whats-new-in-react-18  )

ä¸Šè¨˜ã®ã†ã¡ã€Concurrent featuresã¨å¯†æ¥ã«é–¢ã‚ã‚Šã®ã‚ã‚‹æ©Ÿèƒ½ã¯ã€ŒSuspenseã®SSRå¯¾å¿œã€ã€ŒTransitionsã€ã€ŒuseTransitionã€ã€ŒuseDeferredValueã€ã§ã™ã€‚

ä»¥ä¸‹ã§ã¯ã€ãã‚Œãã‚Œã®æ©Ÿèƒ½ã®æ¦‚è¦ã«ã¤ã„ã¦ç´¹ä»‹ã—ã¾ã™ã€‚

## Suspenseã®SSRå¯¾å¿œ

Suspenseè‡ªä½“ã¯React 16.6ã§å°å…¥ã•ã‚Œã¦ã„ã¾ã—ãŸãŒ[^react16-6]ã€[React.lazy](https://react.dev/reference/react/lazy)ã¨çµ„ã¿åˆã‚ã›ãŸã‚³ãƒ¼ãƒ‰åˆ†å‰²ãŒä¸»ãªåˆ©ç”¨æ–¹æ³•ã§ã—ãŸã€‚

[^react16-6]: [React v16.6.0: lazy, memo and contextType](https://ja.legacy.reactjs.org/blog/2018/10/23/react-v-16-6.html)

React 18ã‹ã‚‰ã¯SuspenseãŒã‚µãƒ¼ãƒä¸Šã§åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

Suspenseã®SSRå¯¾å¿œã«ã¤ã„ã¦è©±ã‚’ã™ã‚‹å‰ã«ã€ã¾ãšã¯Suspenseã¨SSRã«ã¤ã„ã¦ãã‚Œãã‚ŒãŠã•ã‚‰ã„ã‚’ã—ã¾ã™ã€‚

### å¾©ç¿’: Suspenseã¨ã¯
Suspenseã¨ã¯ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãŒå®Œäº†ã™ã‚‹ã¾ã§ã®é–“ã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨å‘¼ã°ã‚Œã‚‹ä»£æ›¿ç”»é¢ã‚’è¡¨ç¤ºã™ã‚‹æ©Ÿèƒ½ã‚’æä¾›ã™ã‚‹ã‚‚ã®ã§ã™ã€‚

Suspenseã®åˆ©ç”¨æ‰‹é †ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

1. å¯¾è±¡ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’Suspenseã§å›²ã†
1. fallbackã‚’æŒ‡å®šã™ã‚‹

ãŸã¨ãˆã°ã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§`Spinner`ã¨ã„ã†ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’è¡¨ç¤ºã™ã‚‹Suspenseã‚’ã€`Comments`ã¨ã„ã†ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«é©ç”¨ã™ã‚‹å ´åˆã¯ä»¥ä¸‹ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã«ãªã‚Šã¾ã™ã€‚

```jsx
<Suspense fallback={<Spinner />}>
  <Comments />
</Suspense>
```

ãªãŠã€Suspenseã¯Concurrent featureã«ãŠã„ã¦é‡è¦ãªå½¹å‰²ã‚’æœãŸã—ã¾ã™ãŒã€Suspenseè‡ªä½“ã¯React 16.6ã‹ã‚‰ã™ã§ã«å­˜åœ¨ã—ã¦ã„ã‚‹ãŸã‚ã€SuspenseãŒReact 18ã®æ–°æ©Ÿèƒ½ã¨ã„ã†ã‚ã‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

Suspenseã®æ´»ç”¨ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ã—ã¦ã¯ä¸»ã«ã€ã‚³ãƒ¼ãƒ‰åˆ†å‰²ã¨å‘¼ã°ã‚Œã‚‹é…å»¶ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’å®Ÿè£…ã™ã‚‹å ´åˆã‚„ã€APIçµŒç”±ã§ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚’ã¯ã˜ã‚ã¨ã—ãŸéåŒæœŸå‡¦ç†ä¸­ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’è¡¨ç¤ºã™ã‚‹å ´åˆãªã©ãŒã‚ã‚Šã¾ã™ã€‚

#### Suspenseã«ã‚ˆã‚‹ã‚³ãƒ¼ãƒ‰åˆ†å‰²

ã‚³ãƒ¼ãƒ‰åˆ†å‰²ã¨ã¯ã€ç”»é¢ã®åˆæœŸè¡¨ç¤ºã«ä¸è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’é…å»¶èª­ã¿è¾¼ã¿ã™ã‚‹ã“ã¨ã§ã€åˆæœŸãƒ­ãƒ¼ãƒ‰ã®æ™‚é–“ã‚’æ¸›ã‚‰ã—ç”»é¢ã®è¡¨ç¤ºé€Ÿåº¦ã‚’å‘ä¸Šã•ã›ã‚‹ã‚‚ã®ã§ã™ã€‚

ã‚³ãƒ¼ãƒ‰åˆ†å‰²ã¯`React.lazy`ã¨Suspenseã‚’çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§å®Ÿç¾ã§ãã¾ã™ã€‚

`React.lazy`ã‚’åˆ©ç”¨ã—ã¦importã•ã‚ŒãŸã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯é…å»¶èª­ã¿è¾¼ã¿ã•ã‚Œã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®èª­ã¿è¾¼ã¿ä¸­ã¯Suspenseã§å®šç¾©ã—ãŸãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

å…·ä½“çš„ãªã‚³ãƒ¼ãƒ‰ã¯ãŸã¨ãˆã°ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```jsx
import { Suspense, lazy } from "react";
const HeavyMessage = lazy(() => import("./HeavyMessage"));

export const App = () => {
  return (
    <Suspense fallback={<div>Loading...</div>}>
      <HeavyMessage />
    </Suspense>
  );
};

```

React 18ä»¥å‰ã§ã¯ã€Suspenseã¯ä¸»ã«ã“ã®ã‚±ãƒ¼ã‚¹ã€ã¤ã¾ã‚Šã‚³ãƒ¼ãƒ‰åˆ†å‰²ã‚’ã™ã‚‹ãŸã‚ã«åˆ©ç”¨ã•ã‚Œã¦ã„ã¾ã—ãŸã€‚


#### Suspenseã¨éåŒæœŸå‡¦ç†ã®çµ„ã¿åˆã‚ã›

Suspenseã¯éåŒæœŸå‡¦ç†ã¨çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§ã€ã€ŒéåŒæœŸå‡¦ç†ä¸­ã¯Suspenseã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’è¡¨ç¤ºã—ã€éåŒæœŸå‡¦ç†ãŒå®Œäº†ã—ãŸã‚‰ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’è¡¨ç¤ºã™ã‚‹ã€ã¨ã„ã£ãŸã“ã¨ãŒå®Ÿç¾ã§ãã¾ã™ã€‚
ã„ã‚ã‚†ã‚‹APIçµŒç”±ã§éåŒæœŸã«ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ã™ã‚‹å ´åˆãŒã“ã®ä¾‹ã«ã‚ãŸã‚Šã¾ã™ã€‚

éåŒæœŸå‡¦ç†ã®çŠ¶æ…‹ã«å¿œã˜ã¦è¡¨ç¤ºã‚’åˆ¶å¾¡ã§ãã‚‹ã®ã¯Suspenseã®ç‰¹æ€§ã«ã‚ˆã‚‹ã‚‚ã®ã§ã™ã€‚

Suspenseã®ç‰¹æ€§ã‚’ã¾ã¨ã‚ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

- Suspenseå†…ã§throwã•ã‚ŒãŸPromiseã‚’catchã™ã‚‹
- PromiseãŒpendingã®æ™‚ã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹
- PromiseãŒsettledï¼ˆfulfilledã‚ã‚‹ã„ã¯rejectedï¼‰ã®æ™‚ã¯ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹

ãªãŠã€Promiseã¨ã¯pendingï¼ˆä¿ç•™ï¼‰ã€fulfilledï¼ˆæˆåŠŸï¼‰ã€rejectedï¼ˆå¤±æ•—ï¼‰ã®3ã¤ã®çŠ¶æ…‹ã‚’æŒã¤éåŒæœŸå‡¦ç†ã‚’è¡¨ã™ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã™ã€‚


Suspenseå†…ã§éåŒæœŸå‡¦ç†ãŒé–‹å§‹ã•ã‚Œã¦ã‹ã‚‰å®Œäº†ã™ã‚‹ã¾ã§ã®æµã‚Œã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

1. Suspenseå†…ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’è©¦ã¿ã‚‹
1. ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‹ã‚‰PromiseãŒthrowã•ã‚Œã‚‹
1. SuspenseãŒthrowã•ã‚ŒãŸPromiseã‚’catchã™ã‚‹
1. Promiseã‚’å‡¦ç†ä¸­ã®å ´åˆã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹
1. Promiseã®å‡¦ç†ãŒå®Œäº†ã—ãŸã‚‰å†åº¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’è©¦ã¿ã‚‹
1. ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãŒã†ã¾ãã„ã£ãŸã‚‰ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‹ã‚‰ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹

å›³ã§è¡¨ç¾ã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

ã¾ãšSuspenseå†…ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’è©¦ã¿ã¾ã™ã€‚

![](/images/overview-concurrent-react/suspense-1.png)

æ¬¡ã«ã€éåŒæœŸå‡¦ç†ãŒçµ„ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‹ã‚‰PromiseãŒthrowã•ã‚Œã¾ã™ã€‚

![](/images/overview-concurrent-react/suspense-2.png)

PromiseãŒthrowã•ã‚Œã‚‹ã¨Suspenseã¯ãã®Promiseã‚’catchã—ã¾ã™ã€‚

![](/images/overview-concurrent-react/suspense-3.png)


PromiseãŒå‡¦ç†ä¸­ã€ã¤ã¾ã‚Špendingã®å ´åˆã¯Suspenseã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã—ã¾ã™ã€‚

![](/images/overview-concurrent-react/suspense-4.png)

Promiseã®å‡¦ç†ãŒçµ‚ã‚ã‚Šã€Promiseã®çŠ¶æ…‹ãŒå®Œäº†ã€ã¤ã¾ã‚Šfulfilledã‚‚ã—ãã¯rejectedã«ãªã£ãŸã‚‰å†åº¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’è©¦ã¿ã¾ã™ã€‚

![](/images/overview-concurrent-react/suspense-5.png)

ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãŒã†ã¾ãã„ã£ãŸã‚‰ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‹ã‚‰ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¸è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚

![](/images/overview-concurrent-react/suspense-6.png)

### å¾©ç¿’: SSRã¨ã¯
SSRã¨ã¯ã‚µãƒ¼ãƒå´ã§HTMLã‚’ç”Ÿæˆã—ã€ãã®çµæœã‚’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«é€ä¿¡ã™ã‚‹ã—ãã¿ã®ã“ã¨ã‚’ã„ã„ã¾ã™ã€‚

SSRã®å¤§ã¾ã‹ãªæµã‚Œã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

1. ãƒ‡ãƒ¼ã‚¿ã®å–å¾—
1. HTMLã‚’è¿”ã™
1. JavaScriptã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
1. HTMLã¨JavaScriptã‚’ã¤ãªãã“ã‚€

å›³ã§è¡¨ç¾ã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

ã¾ãšã€ã‚µãƒ¼ãƒã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå±Šãã¨SSRã«å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã‚’ã—ã¾ã™ã€‚

![](/images/overview-concurrent-react/ssr-1.png)

å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ãŒãã‚ã£ãŸã‚‰ã€ã‚µãƒ¼ãƒå´ã§HTMLã‚’ç”Ÿæˆã—ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã¸ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¨ã—ã¦è¿”ã—ã¾ã™ã€‚

![](/images/overview-concurrent-react/ssr-2.png)

HTMLã‚’å—ã‘å–ã£ãŸã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯ã€JavaScriptã®ãƒ­ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

![](/images/overview-concurrent-react/ssr-3.png)

HTMLã¨JavaScriptã®æº–å‚™ãŒæ•´ã£ãŸã‚‰ã€æ¬¡ã«HTMLã¨JavaScriptã®ã¤ãªãã“ã¿ã‚’è¡Œã„ã¾ã™ã€‚
å…·ä½“çš„ã«ã¯HTMLã«å¯¾ã—ã¦ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠã‚„çŠ¶æ…‹ç®¡ç†ãªã©ã®JavaScriptã®æ©Ÿèƒ½ã‚’ä»˜ä¸ã—ã¾ã™ã€‚
ãªãŠã€ã“ã®éç¨‹ã®ã“ã¨ã‚’ãƒã‚¤ãƒ‰ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¨å‘¼ã³ã¾ã™ã€‚

ãƒã‚¤ãƒ‰ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒå®Œäº†ã™ã‚‹ã¨ã€ç”»é¢ã¯ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ã€ã¤ã¾ã‚Šæ“ä½œå¯èƒ½ãªçŠ¶æ…‹ã«ãªã‚Šã¾ã™ã€‚

![](/images/overview-concurrent-react/ssr-4.png)


SSRã§ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§HTMLã®ç”Ÿæˆã‚’ã™ã‚‹å¿…è¦ãŒãªããªã‚‹ãŸã‚ã€åˆæœŸè¡¨ç¤ºã®é«˜é€ŸåŒ–ãŒæœŸå¾…ã§ãã¾ã™ã€‚
ã¾ãŸã€ã‚¯ãƒ­ãƒ¼ãƒ©ã«å¯¾ã—ã¦ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã—ãŸãƒšãƒ¼ã‚¸ã‚’è¦‹ã›ã‚‰ã‚Œã‚‹ãŸã‚ã€SEOå¯¾ç­–ã¨ã—ã¦æœ‰åŠ¹ã§ã™ã€‚


ä¸€æ–¹ã§ã€SSRã«ã¯ã™ã¹ã¦ã®æº–å‚™ãŒæ•´ã‚ãªã„ã¨åˆæœŸè¡¨ç¤ºãŒã§ããªã„ã¨ã„ã†å•é¡Œç‚¹ãŒã‚ã‚Šã¾ã™ã€‚
å…·ä½“çš„ã«ã¯ã€ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚„ã€JavaScriptã®ãƒ­ãƒ¼ãƒ‰ã‚„ãƒã‚¤ãƒ‰ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«æ™‚é–“ã‚’è¦ã™ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒä¸€éƒ¨ã§ã‚‚å­˜åœ¨ã—ã¦ã„ã‚Œã°ã€ãã‚ŒãŒç”»é¢å…¨ä½“ã®åˆæœŸè¡¨ç¤ºã¾ã§ã«ã‹ã‹ã‚‹æ™‚é–“ã«å½±éŸ¿ã‚’ä¸ãˆã¦ã—ã¾ã„ã¾ã™ã€‚

### Streaming Server Rendering
Suspenseã®SSRå¯¾å¿œã®è©±ã«æˆ»ã‚Šã¾ã™ã€‚

Suspenseã®SSRå¯¾å¿œã¨ã¯ã€éåŒæœŸã§SSRãŒå®Ÿè¡Œã§ãã‚‹ã‚ˆã†ãªã£ãŸã¨ã„ã†ã“ã¨ã‚’æ„å‘³ã—ã¾ã™ã€‚

éåŒæœŸã§SSRã®å‡¦ç†ãŒè¡Œãˆã‚‹ã‚ˆã†ã«ãªã£ãŸçµæœã€ä¸€éƒ¨ã§å‡¦ç†ã®é‡ã„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒã‚ã£ãŸã¨ã—ã¦ã‚‚ã€ç”»é¢å…¨ä½“ãŒãã®å½±éŸ¿ã‚’å—ã‘ãªããªã‚Šã¾ã™ã€‚
ãªãŠã€Suspenseã‚’æ´»ç”¨ã—ã€éåŒæœŸã§SSRã™ã‚‹ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã®ã“ã¨ã‚’Streaming Server Renderingã¨ã„ã„ã¾ã™ã€‚[^2]

[^2]: [Streaming Server Rendering with Suspense](https://www.youtube.com/watch?v=pj5N-Khihgc&list=PLNG_1j3cPCaZZ7etkzWA7JfdmKWT0pMsa&index=4)


ä¸€èˆ¬çš„ãªSSRã¨Streaming Server Renderingã®é•ã„ã‚’å›³ã§è¡¨ç¾ã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
ä»¥ä¸‹ã®å›³ã¯ã€åˆæœŸç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¾ã§ã®éç¨‹ã‚’è¡¨ç¾ã—ãŸã‚‚ã®ã§ã™ã€‚ã“ã“ã§ã¯ç”»é¢å³ä¸‹ã«é‡ã„å‡¦ç†ã‚’è¦ã™ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒå­˜åœ¨ã—ã¦ã„ã‚‹ã¨ã—ã¾ã™ã€‚

![](/images/overview-concurrent-react/streaming.png)

ä¸Šè¨˜ã®å›³ã®æ„å‘³ã«ã¤ã„ã¦è£œè¶³èª¬æ˜ã‚’ã—ã¾ã™ã€‚

SSRã®å ´åˆã¯ã™ã¹ã¦ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«å¯¾ã—ã¦åŒæœŸçš„ã«å‡¦ç†ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
ãã®ãŸã‚ã€å³ä¸‹ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å‡¦ç†é€Ÿåº¦ãŒç”»é¢å…¨ä½“ã«å½±éŸ¿ã‚’ä¸ãˆã¦ã—ã¾ã„ã¾ã™ã€‚

ä¸€æ–¹Streaming Server Renderingã®å ´åˆã¯ã€éåŒæœŸã§å‡¦ç†ã‚’è¡Œã†ãŸã‚ã€å³ä¸‹ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å‡¦ç†é€Ÿåº¦ã¯ç”»é¢å…¨ä½“ã«å½±éŸ¿ã‚’ä¸ãˆã¾ã›ã‚“ã€‚
Streaming Server Renderingã§ã¯éåŒæœŸã§å‡¦ç†ã‚’è¡Œãˆã‚‹ãŸã‚ã€ä¸€éƒ¨ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã ã‘å…ˆã‚“ã˜ã¦ç”»é¢ã«è¡¨ç¤ºã§ãã¾ã™ã€‚

ãªãŠã€Streaming Server Renderingã«ã‚ˆã£ã¦éåŒæœŸã§ã‚µãƒ¼ãƒã‹ã‚‰è¿”ã•ã‚Œã‚‹HTMLã¯Streming HTMLãªã©ã¨å‘¼ã°ã‚Œã¦ã„ã¾ã™ã€‚[^streaming-html]
[^streaming-html]: [New Suspense SSR Architecture in React 18](https://github.com/reactwg/react-18/discussions/37)

## Transitions
Transitionsã¯ç›´è¨³ã™ã‚‹ã¨ã€Œé·ç§»ã€ã¨ã„ã†æ„å‘³ãŒã‚ã‚Šã¾ã™ã€‚
Transitionsã¨ã¯Reactã®ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã«å¯¾ã—ã¦ã€Œå„ªå…ˆåº¦ã€ã®è¦³ç‚¹ã‚’è¿½åŠ ã—ãŸæ–°ã—ã„æ¦‚å¿µã§ã™ã€‚

TransitionsãŒé©ç”¨ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿æ›´æ–°ã¯å„ªå…ˆåº¦ãŒä½ã„ã‚‚ã®ã¨ã¿ãªã•ã‚Œã¾ã™ã€‚
ãã®ãŸã‚ã€Transitionsã‚’æ´»ç”¨ã™ã‚‹ã“ã¨ã§ç›¸å¯¾çš„ã«å„ªå…ˆåº¦ã®é«˜ã„ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã¨å„ªå…ˆåº¦ã®ä½ã„ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã®2ç¨®é¡ã‚’ç”¨æ„ã§ãã¾ã™ã€‚
ä¸€æ–¹ã€å„ªå…ˆåº¦ãŒä½ã„ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã€ã¤ã¾ã‚ŠTransitionsã‚’é©ç”¨ã™ã‚‹ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã«ã¯ã€æ›´æ–°çµæœã‚’å³æ™‚ç”»é¢ã«è¡¨ç¤ºã™ã‚‹å¿…è¦ãŒãªãé…å»¶ã‚’ã—ã¦ã‚‚å•é¡Œãªã„ã‚‚ã®ãŒåˆ†é¡ã•ã‚Œã¾ã™ã€‚

å„ªå…ˆåº¦ã®ä½ã„ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã«ã‚ˆã£ã¦ç™ºç”Ÿã™ã‚‹ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã¯ã€å„ªå…ˆåº¦ã®é«˜ã„ãƒ‡ãƒ¼ã‚¿æ›´æ–°ãŒè¡Œã‚ã‚Œã‚‹ã“ã¨ã§ä¸­æ–­ã•ã‚Œã‚‹ã€ã¨ã„ã†ç‰¹å¾´ãŒã‚ã‚Šã¾ã™ã€‚

è£œè¶³ã§ã™ãŒã€Reactã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯Transitionsã®ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã‚’èª¬æ˜ã™ã‚‹éš›ã«ã€ŒUrgent updatesã€ã¨ã€ŒNon-urgent updatesï¼ˆTransition updatesï¼‰ã€ã¨ã„ã†è¨€è‘‰ã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚[^3]
Urgentã¯ç›´è¨³ã™ã‚‹ã¨ã€Œç·Šæ€¥ã€ã¨ã„ã†æ„å‘³ã§ã™ã®ã§ã€ã€Œç·Šæ€¥åº¦ã®é«˜ã„æ›´æ–°ã€ã¨ã„ã†ã‚ˆã†ãªè¡¨ç¾ã‚’ä½¿ã†ã»ã†ãŒé©åˆ‡ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€æ—¥æœ¬èªã®ã‚ã‹ã‚Šã‚„ã™ã•ã®è¦³ç‚¹ã‹ã‚‰ã€ã“ã“ã§ã¯ã€Œå„ªå…ˆã€ã¨ã„ã†è¨€è‘‰ã‚’åˆ©ç”¨ã—ã¦Transitionsã«ã¤ã„ã¦èª¬æ˜ã‚’ã—ã¦ã„ã¾ã™ã€‚

[^3]: [New Feature: Transitions](https://react.dev/blog/2022/03/29/react-v18#new-feature-transitions)

React 18ã§ã¯Transitionsã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã®HooksãŒæ–°ãŸã«2ã¤ç”¨æ„ã•ã‚Œã¾ã—ãŸã€‚
ãã‚ŒãŒuseTransitionã¨useDeferredValueã§ã™ã€‚

## useTransactionã¨ã¯

useTransitionã¨ã¯Transitionsã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã®Hooksã®1ã¤ã§ã€ã‚¹ãƒ†ãƒ¼ãƒˆã®æ›´æ–°ã«å¯¾ã—ã¦Transitionsã‚’é©ç”¨ã§ãã¾ã™ã€‚

useTransitionã®æˆ»ã‚Šå€¤ã¯`isPending`ã¨ã„ã†booleanã¨`startTransition`ã¨ã„ã†é–¢æ•°ã®2ã¤ã§ã™ã€‚
`isPending`ã¯TransitionsãŒä¿ç•™ä¸­ã‹ã©ã†ã‹ã‚’åˆ¤å®šã™ã‚‹booleanã§ã™ã€‚
`startTransition`ã¯å‡¦ç†ã«å¯¾ã—ã¦Transitionsã‚’é©ç”¨ã™ã‚‹é–¢æ•°ã§ã™ã€‚

useTransitionã®ä½¿ã„æ–¹ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

1. useTransitionã®æˆ»ã‚Šå€¤(isPending, startTransition)ã‚’å–å¾—ã™ã‚‹
1. startTransitionã§Transitionsã‚’é©ç”¨ã™ã‚‹

å…·ä½“ä¾‹ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

ãŸã¨ãˆã°ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã«ã‚ˆã£ã¦ã‚¹ãƒ†ãƒ¼ãƒˆã‚’æ›´æ–°ã™ã‚‹å‡¦ç†ãŒã‚ã£ãŸã¨ã—ã¾ã™ã€‚

```jsx
const [count, setCount] = useState(0);

const handleClick = () => {
  setCount((prev) => prev + 1);
};

```

ä¸Šè¨˜ã®ã‚¹ãƒ†ãƒ¼ãƒˆæ›´æ–°ã«å¯¾ã—ã¦useTransitinoã‚’åˆ©ç”¨ã—ã¦Transitionsã‚’é©ç”¨ã™ã‚‹å ´åˆã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```jsx
const [count, setCount] = useState(0);
const [_, startTransition] = useTransition();

const handleClick = () => {
  startTransition(() => {
    setCount((prev) => prev + 1);
  });
};

```


## useDefferedValueã¨ã¯

useDeferredValueã¨ã¯Transitionsã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã®Hooksã®1ã¤ã§ã€å€¤ã«å¯¾ã—ã¦Transitionsã‚’é©ç”¨ã§ãã¾ã™ã€‚
useDeferredValueã¯å¼•æ•°valueã«å¯¾ã—ã¦Transitionsã‚’é©ç”¨ã•ã›ã‚‹é–¢æ•°ã§ã™ã€‚

useDifferedValueã®ä½¿ã„æ–¹ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

1. Transitionsã‚’é©ç”¨ã—ãŸã„å€¤ã‚’useDeferredValueã®å¼•æ•°ã«ã™ã‚‹
1. useDeferredValueã®æˆ»ã‚Šå€¤ã‚’åˆ©ç”¨ã™ã‚‹


å…·ä½“ä¾‹ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

ãŸã¨ãˆã°ã€ä»¥ä¸‹ã®ã‚ˆã†ãª`query`ã¨ã„ã†ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒ†ãƒ¼ãƒˆã‚’æŒã¤ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«ã¤ã„ã¦è€ƒãˆã¦ã¿ã¾ã™ã€‚
ã“ã®`query`ã«å¯¾ã—ã¦Transitionsã‚’é©ç”¨ã—ãŸã„å ´åˆã¯ã€useDeferredValueã®å¼•æ•°ã«`query`ã‚’ã‚»ãƒƒãƒˆã—ã¾ã™ã€‚
ãã—ã¦ã€useDeferredValueã®æˆ»ã‚Šå€¤ã‚’ãŸã¨ãˆã°`deferredQuery`ã¨ã—ãŸå ´åˆã€`deferredQuery`ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã«ã‚ˆã‚Šã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå†…ã§TransitionsãŒå®Ÿç¾ã§ãã¾ã™ã€‚

```jsx
import { useState, useDeferredValue } from 'react';

function SearchPage() {
  const [query, setQuery] = useState('');
  const deferredQuery = useDeferredValue(query);
  // ...
}

```
